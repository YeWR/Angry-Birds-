{"version":3,"sources":["cameraController.js"],"names":["cc","Class","extends","Component","properties","onLoad","active","initPosition","node","getPosition","setScreenRectangle","bindCenter","center","getComponent","Camera","zoomRatio","setPosition","x","y","previousCenterPosition","setStartScreen","duration","action","moveTo","runAction","bg","parent","size","getContentSize","position","screen","canvas","canvasPos","canvasSize","canvasScree","delta","Vec2","cameraMinPos","cameraMaxPos","add","moveCamera","locationCamera","locationCameraNow","start","update","dt","camera","ready","locationCenter","location","sub","ratioMax","Math","max","width","height"],"mappings":"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","file":"cameraController.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\utils","sourcesContent":["import {getWorldLocation } from '../utils/common';\r\nimport {changeRectangle } from '../utils/common';\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        \r\n    },\r\n\r\n    onLoad () {\r\n        // 是否激活\r\n        this.active = false;\r\n        // 初始位置\r\n        this.initPosition = this.node.getPosition();\r\n        // 屏幕位置\r\n        this.setScreenRectangle();\r\n    },\r\n\r\n    bindCenter : function(center){\r\n        this.active = true;\r\n        this.getComponent(cc.Camera).zoomRatio = 1;\r\n        this.center = center;\r\n        this.node.setPosition(this.initPosition.x, this.initPosition.y);   \r\n        this.previousCenterPosition = getWorldLocation(this.center.node);\r\n    },\r\n\r\n    // 设置开始相机\r\n    setStartScreen(){\r\n        let duration = 1;\r\n        let action = cc.moveTo(duration, 0, 0);\r\n        this.node.runAction(action);\r\n    },\r\n\r\n    // 设置屏幕rec\r\n    setScreenRectangle : function(){\r\n        let bg = this.node.parent;\r\n        let size = bg.getContentSize();\r\n        let position = getWorldLocation(bg);\r\n        // 大屏幕\r\n        this.screen = changeRectangle(position, size);\r\n\r\n        // 偏移\r\n        let canvas = bg.parent;\r\n        let canvasPos = canvas.getPosition();\r\n        let canvasSize = canvas.getContentSize();\r\n        // 小屏幕\r\n        let canvasScree = changeRectangle(canvasPos, canvasSize);\r\n        let delta = new cc.Vec2(this.screen[1] - canvasScree[1], this.screen[3] - canvasScree[3]);\r\n        this.cameraMinPos = canvasPos;\r\n        this.cameraMaxPos = canvasPos.add(delta);\r\n\r\n    },\r\n\r\n    // 移动相机\r\n    moveCamera : function(delta){\r\n        // 相机世界坐标\r\n        let locationCamera = getWorldLocation(this.node);\r\n        // 相机当前位置\r\n        let locationCameraNow = this.node.getPosition();\r\n        // 可以移动x方向\r\n        if(locationCamera.x + delta.x > this.cameraMinPos.x && locationCamera.x + delta.x < this.cameraMaxPos.x){\r\n            locationCameraNow.x += delta.x;\r\n        }\r\n        // 可以移动y方向\r\n        if(locationCamera.y + delta.y > this.cameraMinPos.y && locationCamera.y + delta.y < this.cameraMaxPos.y){\r\n            locationCameraNow.y += delta.y;\r\n        }\r\n        this.node.setPosition(locationCameraNow.x, locationCameraNow.y);        \r\n    },\r\n\r\n    start () {\r\n\r\n    },\r\n\r\n    update (dt) {\r\n        if(this.active){\r\n            let center = this.center;\r\n            let camera = this.getComponent(cc.Camera);\r\n            if(center && center.node && camera && center.ready === -1){\r\n                // 物体当前世界坐标\r\n                let locationCenter = getWorldLocation(center.node);\r\n                // 物体上一dt世界坐标\r\n                let location = this.previousCenterPosition;\r\n                this.previousCenterPosition = locationCenter;\r\n                // 相机世界可能移动坐标\r\n                let delta = locationCenter.sub(location);\r\n                // 移动相机\r\n                this.moveCamera(delta);\r\n            }\r\n        }\r\n        else{\r\n            let zoomRatio = this.getComponent(cc.Camera).zoomRatio;\r\n            let canvas = this.node.parent.parent;\r\n            let size = canvas.getContentSize();\r\n            let ratioMax = Math.max(size.width / (this.screen[1] - this.screen[0]), size.height / (this.screen[3] - this.screen[2])) + 0.01;\r\n            \r\n            zoomRatio -= 0.0025;\r\n            if(zoomRatio >= ratioMax){\r\n                this.getComponent(cc.Camera).zoomRatio = zoomRatio;\r\n            }\r\n        }\r\n    },\r\n});\r\n"]}